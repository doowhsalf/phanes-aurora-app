{"version":3,"sources":["meteor://ðŸ’»app/packages/reywood:publish-composite/lib/publish_composite.js","meteor://ðŸ’»app/packages/reywood:publish-composite/lib/doc_ref_counter.js","meteor://ðŸ’»app/packages/reywood:publish-composite/lib/logging.js","meteor://ðŸ’»app/packages/reywood:publish-composite/lib/publication.js","meteor://ðŸ’»app/packages/reywood:publish-composite/lib/subscription.js","meteor://ðŸ’»app/packages/reywood:publish-composite/lib/published_document.js","meteor://ðŸ’»app/packages/reywood:publish-composite/lib/published_document_list.js"],"names":["module","export","enableDebugLogging","publishComposite","Meteor","link","v","Publication","default","Subscription","debugLog","name","options","publish","Promise","asyncApply","subscription","_len","arguments","length","args","Array","_key","instanceOptions","await","prepareOptions","call","publications","opt","pub","push","onStop","forEach","unpublish","all","flatMap","addedPromises","ready","preparedOptions","apply","isArray","DocumentRefCounter","constructor","observer","heap","increment","collectionName","docId","key","concat","valueOf","decrement","onChange","exportDefault","debugLoggingEnabled","source","message","paddedSource","console","log","_objectSpread","Match","check","PublishedDocumentList","find","Function","children","Optional","OneOf","Object","String","childrenOptions","publishedDocs","cursor","_getCursor","_getCollectionName","observeHandle","observe","added","bindEnvironment","doc","addedPromise","resolve","reject","_handleAddedAsync","then","catch","changed","newDoc","oldDoc","_id","_republishChildrenOf","Set","keys","filter","reduce","changes","removed","_removeDoc","_stopObservingCursor","_unpublishAllDocuments","alreadyPublished","has","unflagForRemoval","add","_publishChildrenOf","_republish","flagAllForRemoval","_removeFlaggedDocs","meteorSub","map","addChildPub","parentArgs","newArgs","eachChildPub","publication","slice","eachDocument","stop","isFlaggedForRemoval","_unpublishChildrenOf","remove","isEqual","Npm","require","docHash","refCounter","refCount","_removeDocHash","_hasDocChanged","_addDocHash","id","_shouldSendChanges","_updateDocHash","buildHashKey","existingDoc","assign","_isDocPublished","some","PublishedDocument","childPublications","_isFlaggedForRemoval","childPublication","callback","child","flagForRemoval","documents","valueOfId","Error","get","context","values","execCallbackOnDoc","getIds","docIds"],"mappings":"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","file":"/packages/reywood_publish-composite.js","sourcesContent":["import { Meteor } from 'meteor/meteor'\n\nimport Publication from './publication'\nimport Subscription from './subscription'\nimport { debugLog, enableDebugLogging } from './logging'\n\nfunction publishComposite (name, options) {\n  return Meteor.publish(name, async function publish (...args) {\n    const subscription = new Subscription(this)\n    const instanceOptions = await prepareOptions.call(this, options, args)\n    const publications = []\n\n    for (const opt of instanceOptions) {\n      const pub = new Publication(subscription, opt)\n      await pub.publish()\n      publications.push(pub)\n    }\n\n    this.onStop(() => {\n      publications.forEach(pub => pub.unpublish())\n    })\n\n    // wait for all publications to finish processing initial added callbacks\n    await Promise.all(publications.flatMap(pub => pub.addedPromises))\n\n    debugLog('Meteor.publish', 'ready')\n    this.ready()\n  })\n}\n\n// For backwards compatibility\nMeteor.publishComposite = publishComposite\n\nasync function prepareOptions (options, args) {\n  let preparedOptions = options\n\n  if (typeof preparedOptions === 'function') {\n    preparedOptions = await preparedOptions.apply(this, args)\n  }\n\n  if (!preparedOptions) {\n    return []\n  }\n\n  if (!Array.isArray(preparedOptions)) {\n    preparedOptions = [preparedOptions]\n  }\n\n  return preparedOptions\n}\n\nexport {\n  enableDebugLogging,\n  publishComposite\n}\n","class DocumentRefCounter {\n  constructor (observer) {\n    this.heap = {}\n    this.observer = observer\n  }\n\n  increment (collectionName, docId) {\n    const key = `${collectionName}:${docId.valueOf()}`\n    if (!this.heap[key]) {\n      this.heap[key] = 0\n    }\n    this.heap[key] += 1\n  }\n\n  decrement (collectionName, docId) {\n    const key = `${collectionName}:${docId.valueOf()}`\n    if (this.heap[key]) {\n      this.heap[key] -= 1\n\n      this.observer.onChange(collectionName, docId, this.heap[key])\n    }\n  }\n}\n\nexport default DocumentRefCounter\n","/* eslint-disable no-console */\n\nlet debugLoggingEnabled = false\n\nfunction debugLog (source, message) {\n  if (!debugLoggingEnabled) { return }\n  let paddedSource = source\n  while (paddedSource.length < 35) { paddedSource += ' ' }\n  console.log(`[${paddedSource}] ${message}`)\n}\n\nfunction enableDebugLogging () {\n  debugLoggingEnabled = true\n}\n\nexport {\n  debugLog,\n  enableDebugLogging\n}\n","import { Meteor } from 'meteor/meteor'\nimport { Match, check } from 'meteor/check'\n\nimport { debugLog } from './logging'\nimport PublishedDocumentList from './published_document_list'\n\nclass Publication {\n  constructor (subscription, options, args) {\n    check(options, {\n      find: Function,\n      children: Match.Optional(Match.OneOf([Object], Function)),\n      collectionName: Match.Optional(String)\n    })\n\n    this.subscription = subscription\n    this.options = options\n    this.args = args || []\n    this.childrenOptions = options.children || []\n    this.publishedDocs = new PublishedDocumentList()\n    this.collectionName = options.collectionName\n    // property to store promises for added callbacks\n    this.addedPromises = []\n  }\n\n  async publish () {\n    this.cursor = await this._getCursor()\n    if (!this.cursor) { return }\n\n    const collectionName = this._getCollectionName()\n\n    // Use Meteor.bindEnvironment to make sure the callbacks are run with the same\n    // environmentVariables as when publishing the \"parent\".\n    // It's only needed when publish is being recursively run.\n    this.observeHandle = this.cursor.observe({\n      added: Meteor.bindEnvironment(async (doc) => {\n        const addedPromise = new Promise((resolve, reject) => {\n          // call the async function to handle the 'added' logic\n          this._handleAddedAsync(doc, collectionName)\n            .then(resolve) // resolve the promise at the end of the 'added' callback\n            .catch(reject)\n        })\n\n        // store the promise\n        this.addedPromises.push(addedPromise)\n      }),\n      changed: Meteor.bindEnvironment((newDoc, oldDoc) => {\n        debugLog('Publication.observeHandle.changed', `${collectionName}:${newDoc._id}`)\n        this._republishChildrenOf(newDoc)\n        this.subscription.changed(collectionName, newDoc._id,\n          [...new Set([...Object.keys(newDoc), ...Object.keys(oldDoc)])]\n            .filter(key => newDoc[key] !== oldDoc[key])\n            .reduce((changes, key) => ({ ...changes, [key]: newDoc[key] }), {}))\n      }),\n      removed: (doc) => {\n        debugLog('Publication.observeHandle.removed', `${collectionName}:${doc._id}`)\n        this._removeDoc(collectionName, doc._id)\n      }\n    })\n  }\n\n  unpublish () {\n    debugLog('Publication.unpublish', this._getCollectionName())\n    this._stopObservingCursor()\n    this._unpublishAllDocuments()\n  }\n\n  async _handleAddedAsync (doc, collectionName) {\n    const alreadyPublished = this.publishedDocs.has(doc._id)\n\n    if (alreadyPublished) {\n      debugLog('Publication.observeHandle.added', `${collectionName}:${doc._id} already published`)\n      this.publishedDocs.unflagForRemoval(doc._id)\n      this._republishChildrenOf(doc)\n      this.subscription.changed(collectionName, doc._id, doc)\n    } else {\n      this.publishedDocs.add(collectionName, doc._id)\n      await this._publishChildrenOf(doc)\n      this.subscription.added(collectionName, doc)\n    }\n  }\n\n  async _republish () {\n    this._stopObservingCursor()\n\n    this.publishedDocs.flagAllForRemoval()\n\n    debugLog('Publication._republish', 'run .publish again')\n    await this.publish()\n\n    debugLog('Publication._republish', 'unpublish docs from old cursor')\n    this._removeFlaggedDocs()\n  }\n\n  async _getCursor () {\n    return await this.options.find.apply(this.subscription.meteorSub, this.args)\n  }\n\n  _getCollectionName () {\n    return this.collectionName || (this.cursor && this.cursor._getCollectionName())\n  }\n\n  async _publishChildrenOf (doc) {\n    const children = typeof this.childrenOptions === 'function'\n      ? this.childrenOptions(doc, ...this.args)\n      : this.childrenOptions\n    await Promise.all(children.map(async (options) => {\n      const pub = new Publication(this.subscription, options, [doc].concat(this.args))\n      this.publishedDocs.addChildPub(doc._id, pub)\n      await pub.publish()\n    }))\n  }\n\n  _republishChildrenOf (doc) {\n    const parentArgs = this.args\n    let newArgs\n    this.publishedDocs.eachChildPub(doc._id, async (publication) => {\n      // Check if parent's args are the same length as this publication\n      // Intuitively this should not ever be the case! However it does happen sometimes.\n      // When it does the first argument of the parent publication is the doc.\n      // So we skip this to avoid creating a duplicate of the first argument.\n      if (parentArgs.length === publication.args.length) {\n        newArgs = parentArgs.slice(1)\n      } else {\n        newArgs = parentArgs\n      }\n\n      // First argument is the new document\n      // Subsequent args are passed down from parent.\n      // These may have been updated by a grandparent publication.\n      publication.args = [doc, ...newArgs]\n\n      await publication._republish()\n    })\n  }\n\n  _unpublishAllDocuments () {\n    this.publishedDocs.eachDocument((doc) => {\n      this._removeDoc(doc.collectionName, doc.docId)\n    }, this)\n  }\n\n  _stopObservingCursor () {\n    debugLog('Publication._stopObservingCursor', 'stop observing cursor')\n\n    if (this.observeHandle) {\n      this.observeHandle.stop()\n      delete this.observeHandle\n    }\n  }\n\n  _removeFlaggedDocs () {\n    this.publishedDocs.eachDocument((doc) => {\n      if (doc.isFlaggedForRemoval()) {\n        this._removeDoc(doc.collectionName, doc.docId)\n      }\n    }, this)\n  }\n\n  _removeDoc (collectionName, docId) {\n    this.subscription.removed(collectionName, docId)\n    this._unpublishChildrenOf(docId)\n    this.publishedDocs.remove(docId)\n  }\n\n  _unpublishChildrenOf (docId) {\n    debugLog('Publication._unpublishChildrenOf', `unpublishing children of ${this._getCollectionName()}:${docId}`)\n\n    this.publishedDocs.eachChildPub(docId, (publication) => {\n      publication.unpublish()\n    })\n  }\n}\n\nexport default Publication\n","import DocumentRefCounter from './doc_ref_counter'\nimport { debugLog } from './logging'\n\n// eslint-disable-next-line\nconst isEqual = Npm.require('lodash.isequal')\n\nclass Subscription {\n  constructor (meteorSub) {\n    this.meteorSub = meteorSub\n    this.docHash = {}\n    this.refCounter = new DocumentRefCounter({\n      onChange: (collectionName, docId, refCount) => {\n        debugLog('Subscription.refCounter.onChange', `${collectionName}:${docId.valueOf()} ${refCount}`)\n        if (refCount <= 0) {\n          meteorSub.removed(collectionName, docId)\n          this._removeDocHash(collectionName, docId)\n        }\n      }\n    })\n  }\n\n  added (collectionName, doc) {\n    this.refCounter.increment(collectionName, doc._id)\n\n    if (this._hasDocChanged(collectionName, doc._id, doc)) {\n      debugLog('Subscription.added', `${collectionName}:${doc._id}`)\n      this.meteorSub.added(collectionName, doc._id, doc)\n      this._addDocHash(collectionName, doc)\n    }\n  }\n\n  changed (collectionName, id, changes) {\n    if (this._shouldSendChanges(collectionName, id, changes)) {\n      debugLog('Subscription.changed', `${collectionName}:${id}`)\n      this.meteorSub.changed(collectionName, id, changes)\n      this._updateDocHash(collectionName, id, changes)\n    }\n  }\n\n  removed (collectionName, id) {\n    debugLog('Subscription.removed', `${collectionName}:${id.valueOf()}`)\n    this.refCounter.decrement(collectionName, id)\n  }\n\n  _addDocHash (collectionName, doc) {\n    this.docHash[buildHashKey(collectionName, doc._id)] = doc\n  }\n\n  _updateDocHash (collectionName, id, changes) {\n    const key = buildHashKey(collectionName, id)\n    const existingDoc = this.docHash[key] || {}\n    this.docHash[key] = Object.assign(existingDoc, changes)\n  }\n\n  _shouldSendChanges (collectionName, id, changes) {\n    return this._isDocPublished(collectionName, id) &&\n            this._hasDocChanged(collectionName, id, changes)\n  }\n\n  _isDocPublished (collectionName, id) {\n    const key = buildHashKey(collectionName, id)\n    return !!this.docHash[key]\n  }\n\n  _hasDocChanged (collectionName, id, doc) {\n    const existingDoc = this.docHash[buildHashKey(collectionName, id)]\n\n    if (!existingDoc) { return true }\n\n    return Object.keys(doc).some(key => !isEqual(doc[key], existingDoc[key]))\n  }\n\n  _removeDocHash (collectionName, id) {\n    const key = buildHashKey(collectionName, id)\n    delete this.docHash[key]\n  }\n}\n\nfunction buildHashKey (collectionName, id) {\n  return `${collectionName}::${id.valueOf()}`\n}\n\nexport default Subscription\n","class PublishedDocument {\n  constructor (collectionName, docId) {\n    this.collectionName = collectionName\n    this.docId = docId\n    this.childPublications = []\n    this._isFlaggedForRemoval = false\n  }\n\n  addChildPub (childPublication) {\n    this.childPublications.push(childPublication)\n  }\n\n  eachChildPub (callback) {\n    for (const child of this.childPublications) {\n      callback(child)\n    }\n  }\n\n  isFlaggedForRemoval () {\n    return this._isFlaggedForRemoval\n  }\n\n  unflagForRemoval () {\n    this._isFlaggedForRemoval = false\n  }\n\n  flagForRemoval () {\n    this._isFlaggedForRemoval = true\n  }\n}\n\nexport default PublishedDocument\n","import PublishedDocument from './published_document'\n\nclass PublishedDocumentList {\n  constructor () {\n    this.documents = {}\n  }\n\n  add (collectionName, docId) {\n    const key = valueOfId(docId)\n\n    if (!this.documents[key]) {\n      this.documents[key] = new PublishedDocument(collectionName, docId)\n    }\n  }\n\n  addChildPub (docId, publication) {\n    if (!publication) { return }\n\n    const key = valueOfId(docId)\n    const doc = this.documents[key]\n\n    if (typeof doc === 'undefined') {\n      throw new Error(`Doc not found in list: ${key}`)\n    }\n\n    this.documents[key].addChildPub(publication)\n  }\n\n  get (docId) {\n    const key = valueOfId(docId)\n    return this.documents[key]\n  }\n\n  remove (docId) {\n    const key = valueOfId(docId)\n    delete this.documents[key]\n  }\n\n  has (docId) {\n    return !!this.get(docId)\n  }\n\n  eachDocument (callback, context) {\n    Object.values(this.documents).forEach(function execCallbackOnDoc (doc) {\n      callback.call(this, doc)\n    }, context || this)\n  }\n\n  eachChildPub (docId, callback) {\n    const doc = this.get(docId)\n\n    if (doc) {\n      doc.eachChildPub(callback)\n    }\n  }\n\n  getIds () {\n    const docIds = []\n\n    this.eachDocument((doc) => {\n      docIds.push(doc.docId)\n    })\n\n    return docIds\n  }\n\n  unflagForRemoval (docId) {\n    const doc = this.get(docId)\n\n    if (doc) {\n      doc.unflagForRemoval()\n    }\n  }\n\n  flagAllForRemoval () {\n    this.eachDocument((doc) => {\n      doc.flagForRemoval()\n    })\n  }\n}\n\nfunction valueOfId (docId) {\n  if (docId === null) {\n    throw new Error('Document ID is null')\n  }\n  if (typeof docId === 'undefined') {\n    throw new Error('Document ID is undefined')\n  }\n  return docId.valueOf()\n}\n\nexport default PublishedDocumentList\n"]}