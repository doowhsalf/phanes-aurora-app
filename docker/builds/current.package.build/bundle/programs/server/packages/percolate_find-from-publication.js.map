{"version":3,"sources":["meteor://ðŸ’»app/packages/percolate:find-from-publication/server.js","meteor://ðŸ’»app/packages/percolate:find-from-publication/utils.js"],"names":["module","export","FindFromPublication","Meteor","link","v","METADATA_COLLECTION","constructId","publish","publicationName","fn","rank","oldAdded","added","bind","oldRemoved","removed","collectionName","documentId","doc","apply","arguments","id","concat"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAAA,MAAM,CAACC,MAAM,CAAC;EAACC,mBAAmB,EAACA,CAAA,KAAIA;AAAmB,CAAC,CAAC;AAAC,IAAIC,MAAM;AAACH,MAAM,CAACI,IAAI,CAAC,eAAe,EAAC;EAACD,MAAMA,CAACE,CAAC,EAAC;IAACF,MAAM,GAACE,CAAC;EAAA;AAAC,CAAC,EAAC,CAAC,CAAC;AAAC,IAAIC,mBAAmB,EAACC,WAAW;AAACP,MAAM,CAACI,IAAI,CAAC,SAAS,EAAC;EAACE,mBAAmBA,CAACD,CAAC,EAAC;IAACC,mBAAmB,GAACD,CAAC;EAAA,CAAC;EAACE,WAAWA,CAACF,CAAC,EAAC;IAACE,WAAW,GAACF,CAAC;EAAA;AAAC,CAAC,EAAC,CAAC,CAAC;AAGhQ,MAAMH,mBAAmB,GAAG,CAAC,CAAC;AAErCA,mBAAmB,CAACM,OAAO,GAAG,UAASC,eAAe,EAAEC,EAAE,EAAE;EAC1DP,MAAM,CAACK,OAAO,CAACC,eAAe,EAAE,YAAW;IACzC,IAAIE,IAAI,GAAG,CAAC;IACZ,MAAMC,QAAQ,GAAG,IAAI,CAACC,KAAK,CAACC,IAAI,CAAC,IAAI,CAAC;IACtC,MAAMC,UAAU,GAAG,IAAI,CAACC,OAAO,CAACF,IAAI,CAAC,IAAI,CAAC;IAE1C,IAAI,CAACD,KAAK,GAAG,CAACI,cAAc,EAAEC,UAAU,EAAEC,GAAG,KAAK;MAChDP,QAAQ,CAACK,cAAc,EAAEC,UAAU,EAAEC,GAAG,CAAC;MAEzCP,QAAQ,CAACN,mBAAmB,EAAEC,WAAW,CAACU,cAAc,EAAER,eAAe,EAAES,UAAU,CAAC,EAAE;QACtFD,cAAc;QACdC,UAAU;QACVT,eAAe;QACf;QACA;QACAE;MACF,CAAC,CAAC;MAEFA,IAAI,IAAI,CAAC;IACX,CAAC;IAED,IAAI,CAACK,OAAO,GAAG,CAACC,cAAc,EAAEC,UAAU,KAAK;MAC7C;MACA;MACA;MACA,IAAID,cAAc,KAAKX,mBAAmB,EAAE;MAE5CS,UAAU,CAACT,mBAAmB,EAAEC,WAAW,CAACU,cAAc,EAAER,eAAe,EAAES,UAAU,CAAC,CAAC;MACzFH,UAAU,CAACE,cAAc,EAAEC,UAAU,CAAC;IACxC,CAAC;IAED,OAAOR,EAAE,CAACU,KAAK,CAAC,IAAI,EAAEC,SAAS,CAAC;EAClC,CAAC,CAAC;AACJ,CAAC,C;;;;;;;;;;;ACtCDrB,MAAM,CAACC,MAAM,CAAC;EAACK,mBAAmB,EAACA,CAAA,KAAIA,mBAAmB;EAACC,WAAW,EAACA,CAAA,KAAIA;AAAW,CAAC,CAAC;AAAjF,MAAMD,mBAAmB,GAAG,sBAAsB;AAElD,MAAMC,WAAW,GAAGA,CAACU,cAAc,EAAER,eAAe,EAAEa,EAAE,QAAAC,MAAA,CAC1DN,cAAc,OAAAM,MAAA,CAAId,eAAe,OAAAc,MAAA,CAAID,EAAE,CAAE,C","file":"/packages/percolate_find-from-publication.js","sourcesContent":["import { Meteor } from \"meteor/meteor\";\nimport { METADATA_COLLECTION, constructId } from \"./utils\";\n\nexport const FindFromPublication = {};\n\nFindFromPublication.publish = function(publicationName, fn) {\n  Meteor.publish(publicationName, function() {\n    let rank = 0;\n    const oldAdded = this.added.bind(this);\n    const oldRemoved = this.removed.bind(this);\n\n    this.added = (collectionName, documentId, doc) => {\n      oldAdded(collectionName, documentId, doc);\n\n      oldAdded(METADATA_COLLECTION, constructId(collectionName, publicationName, documentId), {\n        collectionName,\n        documentId,\n        publicationName,\n        // NOTE: this rank is incremented across all collections\n        // probably doesn't matter?\n        rank\n      });\n\n      rank += 1;\n    };\n\n    this.removed = (collectionName, documentId) => {\n      // the only way this can get called is when all documents are removed\n      // from the subscription as it's torn down, we know that the underlying document\n      // will also be removed, and this will pick it up.\n      if (collectionName === METADATA_COLLECTION) return;\n\n      oldRemoved(METADATA_COLLECTION, constructId(collectionName, publicationName, documentId));\n      oldRemoved(collectionName, documentId);\n    };\n\n    return fn.apply(this, arguments);\n  });\n};\n","export const METADATA_COLLECTION = 'subscriptionMetadata';\n\nexport const constructId = (collectionName, publicationName, id) => \n  `${collectionName}-${publicationName}-${id}`;"]}